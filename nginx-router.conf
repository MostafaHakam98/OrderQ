# Map user agents to determine if request is from mobile device
map $http_user_agent $mobile_upstream {
    default "http://frontend:80";
    ~*android "http://flutter-pwa:80";
    ~*iphone "http://flutter-pwa:80";
    ~*ipad "http://flutter-pwa:80";
    ~*ipod "http://flutter-pwa:80";
    ~*mobile "http://flutter-pwa:80";
    ~*blackberry "http://flutter-pwa:80";
    ~*windows\s+phone "http://flutter-pwa:80";
    ~*opera\s+mini "http://flutter-pwa:80";
    ~*palm "http://flutter-pwa:80";
    ~*webos "http://flutter-pwa:80";
}

server {
    listen 80;
    server_name _;
    
    # Docker's internal DNS resolver (required for resolving service names)
    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;
    
    # Set variables for upstream services (using variables forces runtime DNS resolution)
    set $backend_url "http://backend:8000";
    set $frontend_url "http://frontend:80";
    set $flutter_pwa_url "http://flutter-pwa:80";
    
    # Proxy WebSocket connections to backend
    location /ws {
        proxy_pass $backend_url;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # Proxy API requests to backend
    location /api {
        proxy_pass $backend_url;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Route based on user agent (mobile -> Flutter PWA, desktop -> Vue frontend)
    location / {
        proxy_pass $mobile_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
    }
}

